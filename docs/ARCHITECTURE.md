# Fitness App — Architecture Spec (v1)

## Goal
A global fitness platform combining nutrition tracking, recipes/meal planning, pantry/fridge inventory, workouts, analytics, and community features (feedback + forum). Flutter mobile app + Django/DRF backend in a single monorepo.

## Repo layout (monorepo)
- apps/backend: Django + DRF + Postgres (Poetry)
- apps/mobile: Flutter
- contracts/openapi.yaml: API contract (generated by backend)
- docs/: architecture + roadmap

## Core design principles
1) **Three data layers**
   - External catalog: Open Food Facts (OFF) + recipe dataset imports (cached/attributed).
   - Community catalog: user-submitted public recipes/products/exercises (moderated).
   - Private user data: logs, plans, inventory, sessions (immediate, no approval needed).

2) **Private-first publishing**
   - Users can create private items instantly.
   - “Publish to community” creates a Submission and requires approval.

3) **Contract-first API**
   - Backend generates OpenAPI spec.
   - CI fails if contracts/openapi.yaml is out-of-date.

4) **Normalize “ingredients/nutrients” once**
   - A canonical Ingredient + Nutrient registry enables:
     - custom nutrient tracking (e.g., creatine, vitamin D)
     - pantry↔recipe matching
     - analytics consistency

## Backend stack
- Django + DRF
- Postgres as system-of-record
- Redis + Celery (phase-in) for ETL, aggregates, moderation workflows
- JWT auth (SimpleJWT)
- OpenAPI generation (e.g., drf-spectacular)

## Backend modules (Django apps)
- accounts: auth + profile
- preferences: units, goals, dietary prefs, allergies
- nutrients: NutrientDefinition + units + user custom nutrients
- foods: FoodItem catalog + OFF ingest cache
- nutrition: meal log + food entries + daily totals
- recipes: recipes + ingredients + ratings
- meal_plans: weekly plans + planned meals
- inventory: pantry/fridge + expiry + (later) inventory events
- workouts: exercises + sessions + sets + templates
- analytics: read-only insights + aggregate tables/jobs
- moderation: submissions/approvals/reports reusable across content types
- feedback: feature requests + votes + comments
- forum: categories + threads + posts (later)
- realtime: training-together (later)

## Open Food Facts integration (hybrid)
- OFF enforces rate limits; read product queries are limited and search queries are stricter. Requests from users directly apply limits per user.
- Mobile sets custom User-Agent per OFF guidance.
- Flow:
  1) Mobile searches local cache and backend typeahead.
  2) On explicit search or barcode scan, mobile calls OFF product/search endpoints.
  3) Mobile POSTs normalized payload + raw OFF JSON to backend for storage.

## Moderation (single reusable pipeline)
- Submission: (type: recipe/product/exercise/forum_post), status: pending/approved/rejected
- ModerationDecision: reviewer, decision, reason, timestamp
- Report: user flags content; triggers review/auto-hide thresholds (later)

## API conventions
- Versioned routes: /api/v1/...
- All user-owned endpoints are scoped to authenticated user.
- Consistent error format, pagination defaults, and ISO-8601 timestamps in UTC.

## Mobile architecture
- Feature-based structure:
  - core/: config, routing, auth storage, API client, error handling
  - features/{auth,settings,nutrition,workouts,inventory,recipes,analytics,feedback,forum}
- Environments/flavors:
  - local backend vs staging (Render) vs production

## Non-goals for v1
- Full OFF database import into Postgres (start with caching + selective import).
- Realtime “training together” (design later; implement after core logging is solid).
